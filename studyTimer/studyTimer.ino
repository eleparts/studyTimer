// ì‚¬ìš© ë¼ì´ë¸ŒëŸ¬ë¦¬
// ê³µì‹ ë¼ì´ë¸ŒëŸ¬ë¦¬ ( ë¼ì´ë¸ŒëŸ¬ë¦¬ ë§¤ë‹ˆì €ì—ì„œ ì„¤ì¹˜í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ )
#include <SPI.h>
#include <Wire.h>

// ê°œì¸ì´ ì§ì ‘ ì¶”ê°€í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬
#include "RTClib.h"
#include "EPD_2in9_V2.h"
#include "GUI_Paint.h"
#include "fonts.h"

// ì „ì›(ì „ì²´ ì‹œì‘ / ì •ì§€) / ëª¨ë“œ ì œì–´ìš© ë²„íŠ¼ ì´ë¦„ ì§€ì •
#define BTN_POWER  2
#define BTN_MODE   3

// ì½”ë”©ì—ì„œ ì‚¬ìš©í•  ë³€ìˆ˜ ì„ ì–¸
// enum = ìˆ«ìì— ì˜ë¯¸ ìˆëŠ” ì´ë¦„ì„ ë¶™ì´ëŠ” ë°©ë²•
enum State { STUDY, REST };
State state = STUDY;

RTC_DS3231 rtc;

bool powerOn = false;

DateTime now;
uint32_t lastUnix = 0;
uint32_t studySec = 0;
uint32_t restSec  = 0;

unsigned long lastRTCRead = 0;
unsigned long lastDraw    = 0;
unsigned long powerOffRequestedAt = 0;

UBYTE *BlackImage;

// ê³µë¶€ì¤‘, íœ´ì‹ì¤‘ ì˜†ì— í•¨ê»˜ ë„ìš¸ ì´ëª¨ì§€
const uint8_t pen[32][32] = {
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,1,1,1,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,1,1,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,1,1,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,1,0,0,1,1,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,1,1,1,1,1,1,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,1,1,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,1,1,1,1,1,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,1,1,0,1,1,1,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,1,1,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,1,1,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0},
  {0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
};

const uint8_t coffee[32][32] = {
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,1,1,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,1,1,1,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,1,1,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,1,1,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,1,0,1,1,0,1,1,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,1,1,1,1,1,1,1,1,0,0,0,0,1,0,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0},
  {0,1,1,1,1,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,1,1,1,0,1,1,1,0,0},
  {0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,1,0},
  {0,1,1,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,1,1,0},
  {0,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,1,1,0},
  {0,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,1,1,1,0},
  {0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0},
  {0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0},
  {0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0},
  {0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0},
  {0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
};


void setup() {
  // ì‹œë¦¬ì–¼ & I2C í†µì‹  ì‹œì‘
  Serial.begin(115200);
  Wire.begin();

  // ë²„íŠ¼ í•€ ì„¤ì •
  pinMode(BTN_POWER, INPUT_PULLUP);
  pinMode(BTN_MODE,  INPUT_PULLUP);

  // RTC ëª¨ë“ˆ ì‹œì‘
  rtc.begin();

  DEV_Module_Init();     // EPD í•˜ë“œì›¨ì–´ ì´ˆê¸°í™”
  EPD_2IN9_V2_Init();    // EPD íŒ¨ë„ ì´ˆê¸°í™”
  EPD_2IN9_V2_Clear();   // í™”ë©´ ì§€ìš°ê¸°
  EPD_2IN9_V2_Sleep();   // ì €ì „ë ¥ ëª¨ë“œë¡œ ì „í™˜

  UWORD Imagesize = ((EPD_2IN9_V2_WIDTH + 7) / 8) * EPD_2IN9_V2_HEIGHT;   // EPD í™”ë©´ ì „ì²´ë¥¼ ë‹´ì„ ìˆ˜ ìˆëŠ” í¬ê¸° ê³„ì‚°
  BlackImage = (UBYTE *)malloc(Imagesize);                                // í™”ë©´ ì‚¬ì´ì¦ˆë§Œí¼ ë²„í¼ í™•ë³´

  Paint_NewImage(BlackImage, EPD_2IN9_V2_WIDTH, EPD_2IN9_V2_HEIGHT, 90, WHITE);   // ì•ì„œ ë§Œë“  ë²„í¼ ì´ˆê¸°í™”
  Paint_SelectImage(BlackImage);                                                  // ì´ë¯¸ì§€ ì„ íƒ
  Paint_Clear(WHITE);                                                             // í™”ë©´ì„ í°ìƒ‰ìœ¼ë¡œ ì´ˆê¸°í™”
}

void loop() {
  handlePowerButton();                // ê³µë¶€ ì œì–´ ë²„íŠ¼ ì œì–´ í•¨ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸°

  if (!powerOn) return;               // powerOn ë³€ìˆ˜ê°€ 0ì´ë©´ ë°˜í™˜

  if (powerOffRequestedAt != 0) {     // ë²„íŠ¼ì„ í•œ ë²ˆ ëˆ„ë¥¸ ìƒíƒœì—ì„œ í•œ ë²ˆ ë” ëˆŒë €ì„ ê²½ìš°,
    checkPowerOffTimer();             // 10ì´ˆ ì¹´ìš´íŠ¸ í›„ EPD ì´ˆê¸°í™” í•˜ëŠ” í•¨ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸°
    return;
  }

  handleModeButton();                 // íœ´ì‹ ì œì–´ ë²„íŠ¼ ì œì–´ í•¨ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸°
  updateRTC();                        // RTC ì œì–´ í•¨ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸°
  updateDisplay();                    // EPD ì œì–´ í•¨ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸°
}

void handlePowerButton() {              // ê³µë¶€ ì‹œì‘/ì¤‘ì§€ ì œì–´ í•¨ìˆ˜
  static bool lastBtn = HIGH;
  bool btn = digitalRead(BTN_POWER);    // ê³µë¶€ ë²„íŠ¼ ì…ë ¥ ê°’ ë°›ì•„ì˜¤ê¸°

  // í•¨ìˆ˜ ëì— lastBtnì— btn ê°’ì„ ë„£ì–´ì£¼ê³ , ì´ì „ ê°’ê³¼ ë¹„êµí•˜ì—¬ ë‹¤ë¥¼ ë•Œ ë™ì‘ë˜ë„ë¡ ì„¤ì •
  if (lastBtn == HIGH && btn == LOW) {
    if (!powerOn) {             // powerOn ë³€ìˆ˜ê°€ 0ì¼ ë•Œ
      // ğŸ”Œ POWER ON
      powerOn = true;           // powerOn ë³€ìˆ˜ë¥¼ 1ë¡œ ì…‹
      state = STUDY;            // stateë¥¼ ê³µë¶€ì¤‘ìœ¼ë¡œ, ì‹œê°„ ê°’ë“¤ì„ 0ìœ¼ë¡œ ì´ˆê¸°í™”
      studySec = 0;
      restSec  = 0;
      powerOffRequestedAt = 0;

      now = rtc.now();
      lastUnix = now.unixtime();

      EPD_2IN9_V2_Init();       // í™”ë©´ í•œë²ˆ ì´ˆê¸°í™”
      EPD_2IN9_V2_Clear();
    } else {
      // ğŸ”Œ POWER OFF ìš”ì²­
      powerOffRequestedAt = millis();
    }
  }
  lastBtn = btn;
}

void handleModeButton() {               // íœ´ì‹ ì‹œì‘/ì¤‘ì§€ ì œì–´ í•¨ìˆ˜
  static bool lastBtn = HIGH;
  bool btn = digitalRead(BTN_MODE);

  if (lastBtn == HIGH && btn == LOW) {
    // state ê°€ STUDYë©´ RESTë¡œ, STUDYê°€ ì•„ë‹ˆë©´ STUDYë¡œ ê°’ ì§€ì •
    state = (state == STUDY) ? REST : STUDY;   

    EPD_2IN9_V2_Clear();
  }
  lastBtn = btn;
}

void updateRTC() {            // RTC ì—…ë°ì´íŠ¸ í•¨ìˆ˜
  // RTC ì½ì€ ì´í›„ 1ì´ˆê°€ ì§€ë‚¬ì„ ë•Œ ì•„ë˜ ì½”ë“œ ë™ì‘
  if (millis() - lastRTCRead < 1000) return;    

  // ì§€ë‚œ í˜¸ì¶œ ì´í›„ ì§€ë‚œ ì‹œê°„ ê³„ì‚°
  now = rtc.now();
  uint32_t u = now.unixtime();
  uint32_t diff = u - lastUnix;
  lastUnix = u;
  
  // ìƒíƒœë¥¼ í™•ì¸í•˜ì—¬, ìœ„ì—ì„œ ê³„ì‚°í•œ ì‹œê°„ë§Œí¼ ë”í•˜ê¸°
  if (state == STUDY) studySec += diff;
  else               restSec  += diff;

  lastRTCRead = millis();
}

void updateDisplay() {            // EPD ì—…ë°ì´íŠ¸ í•¨ìˆ˜
  // EPD ê·¸ë¦¬ê³  1ì´ˆê°€ ì§€ë‚¬ì„ ë•Œ ì•„ë˜ ì½”ë“œ ë™ì‘
  if (millis() - lastDraw < 1000) return;

  Paint_Clear(WHITE);   // í°ìƒ‰ìœ¼ë¡œ í™”ë©´ ì´ˆê¸°í™”

  // state ê°’ì— ë”°ë¼ ìƒë‹¨ ë¬¸êµ¬ì™€ ì´ëª¨ì§€ ì¶œë ¥
  if (state == STUDY) {
    Paint_DrawString_EN(10, 10, "STATE: STUDY", &Font24, BLACK, WHITE);
    drawEmoji(220, 5, pen, 32);
  } else {
    Paint_DrawString_EN(10, 10, "STATE: REST", &Font24, BLACK, WHITE);
    drawEmoji(220, 5, coffee, 32);
  }

  // í•˜ë‹¨ì— ê³µë¶€ ì‹œê°„ ë° íœ´ì‹ ì‹œê°„ í‘œì‹œ
  char buf[32];
  sprintf(buf, "STUDY | %luh : %lum : %lus", studySec / 3600, (studySec % 3600) / 60, (studySec % 3600) % 60);
  Paint_DrawString_EN(10, 40, buf, &Font16, BLACK, WHITE);

  sprintf(buf, "REST  | %luh : %lum : %lus", restSec / 3600, (restSec % 3600) / 60, (restSec % 3600) % 60);
  Paint_DrawString_EN(10, 60, buf, &Font16, BLACK, WHITE);

  // ê° ì‚¬ìš© ë²„íŠ¼ ì„¤ëª… ê¸°ì…
  Paint_DrawString_EN(10, 100, "BTN2: Power BUTTON", &Font12, BLACK, WHITE);
  Paint_DrawString_EN(10, 115, "BTN3: Mode Control", &Font12, BLACK, WHITE);

  // EPD ë¶€ë¶„ ê°±ì‹ 
  EPD_2IN9_V2_Display_Partial(BlackImage);

  lastDraw = millis();
}

// ê³µë¶€ ë§ˆì³¤ì„ ë•Œ, ì‹¤í–‰ì‹œí‚¬ í™”ë©´ ì´ˆê¸°í™” í•¨ìˆ˜
void checkPowerOffTimer() {
  // ì „ì› OFF ìš”ì²­ì´ ìˆì„ ë•Œì—ë§Œ, powerOffRequestAt ë³€ìˆ˜ê°€ 1ì¼ ë•Œì—ë§Œ ì•„ë˜ ì½”ë“œ ë™ì‘
  if (powerOffRequestedAt == 0) return;

  // 10ì´ˆ ì¹´ìš´íŠ¸ í›„ í™”ë©´ ì´ˆê¸°í™”
  if (millis() - powerOffRequestedAt >= 10000) {
    EPD_2IN9_V2_Init();
    EPD_2IN9_V2_Clear();
    delay(500);

    powerOn = false;
    powerOffRequestedAt = 0;
  }
}

// í”½ì…€ í¬ê¸°ë§Œí¼ forë¬¸ìœ¼ë¡œ í™•ì¸, ìœ„ì¹˜ ê°’ì´ 1ì´ë©´, í”½ì…€ ê·¸ë¦¬ê¸°
// ìœ„ì—ì„œ ì‘ì„±í•œ pen, coffee ì´ëª¨ì§€ ê·¸ë¦¬ëŠ” í•¨ìˆ˜
void drawEmoji(int x, int y, const uint8_t emoji[][32], int size) {
  for (int row = 0; row < size; row++) {
    for (int col = 0; col < size; col++) {
      if (emoji[row][col]) {
        Paint_DrawPoint(
          x + col,
          y + row,
          BLACK,
          DOT_PIXEL_1X1,
          DOT_STYLE_DFT
        );
      }
    }
  }
}
